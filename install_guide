# this will install both ArcGIS entreprise and jupyter notebooks for ArcGIS

# from your computer, ssh into the machine
# ssh dti-a-idul@machine.ip.adress

# verify that you have the right OS version for ArcGIS installed on the machine
# cat /etc/os-release

# install chef: type password when prompted
#curl -L https://omnitruck.chef.io/install.sh | sudo bash
 curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P chefdk -c stable -v 4.13.3 # make sure the version is the latest

# install git if not already installed
# https://git-scm.com/download/linux

# optional: create a folder for your repos and cd into into
mkdir repos
cd repos

# get git repo from github
git clone https://github.com/jfaurelacroix/foretclimat

# alternatively
# git clone https://github.com/Esri/arcgis-cookbook

# inside the cookbooks folder, add necessary cookbooks from chef
cd cookbooks
git clone https://github.com/sous-chefs/nfs.git
git clone https://github.com/sous-chefs/line.git
# make sure that you have all the required license and authorization files
# to create a named license file for your machine, you'll need some specific
# information about your machine


# make sure that you have all the required tar files available
##ArcGIS_DataStore_Linux_109_177887.tar.gz
##ArcGIS_Server_Linux_109_177864.tar.gz
##ArcGIS_Web_Adaptor_Java_Linux_109_177888.tar.gz
##Portal_for_ArcGIS_Linux_109_177885.tar.gz
##Portal_for_ArcGIS_Web_Styles_Linux_109_177886.tar.gz



# for Jupyter notebooks
## ArcGIS_Notebook_Docker_Advanced_109_177823.tar.gz
## ArcGIS_Notebook_Docker_Standard_109_177822.tar.gz
## ArcGIS_Notebook_Server_Linux_109_177908.tar.gz
## ArcGIS_Notebook_Server_Samples_Data_Linux_109_177914.tar.gz
## ArcGIS_Server_Linux_109_177864.tar.gz
## ArcGIS_Web_Adaptor_Java_Linux_109_177888.tar.gz
## apache-tomcat-8.5.63.tar.gz (will be downloaded from the internet if not present in the local ArcGIS software repository)
## openjdk-11_linux-x64_bin.tar.gz (will be downloaded from the internet if not present in the local ArcGIS software repository)

# ArcGIS software repository directory is specified by arcgis.repository.archives attribute. By default it is set to local directory 
# /opt/software/archives on Linux. However, it is recommended to create an ArcGIS software repository 
# located on a separate file server that is accessible from all the machines in the deployment for the user account used to run Chef client.
mkdir /gisdata/arcgisserver/config-store
mkdir /home/centos/gisdata/arcgisportal/content
mkdir arcgis_data/archives
mv <files> arcgis_data/archives
# if needed, transfer files from valerias globus endpoint
scp -r idul@login.valeria.science:projects/ul-val-prj-foret-climat_at_valeria.science/incoming/ .

mv ArcGIS_Enterprise_Portal_109_.json /opt/software/authorization_files/10.9/
# Enable running sudo without password for the user running the Chef client.

# locate the chef script you will need to use

# chef overview:

# run the chef script
# The single machine deployment uses one machine for file server and primary machine roles.
chef-client -z -j arcgis-enterprise-fileserver.json
chef-client -z -j arcgis-enterprise-primary.json

# your first run of chef will request that you accept 2
# product licenses

# If you don't plan adding standby machine in the future, don't configure the file server 
# and use local paths instead of shared directories for ArcGIS Server server directories, 
# Portal for ArcGIS content directory, and ArcGIS Data Store backup directories in arcgis-enterprise-primary.json.


# Install certbot
# https://certbot.eff.org/
# first install snapd
# https://snapcraft.io/docs/installing-snapd
sudo yum install epel-release
sudo yum install snapd

sudo yum install mod_ssl
sudo yum install firewalld
sudo systemctl enable --now snapd.socket
#reboot
sudo snap install core; sudo snap refresh core
sudo snap install --classic certbot
sudo snap install dmidecode-tool
sudo ln -s /snap/bin/certbot /usr/bin/certbot


# make sure that your DNS is set correctly with the right IP address

sudo certbot certonly --standalone

cp /etc/letsencrypt/live/foretclimat.ca/fullchain.pem /tomcat_arcgis/
# /etc/letsencrypt/live/foretclimat.ca/privkey.pem

sudo systemctl enable firewalld
# reboot

# make sure that ports 7443 and 

cd /opt/cinc
sudo sudo cinc-client -z -j arcgis-enterprise-primary.json
