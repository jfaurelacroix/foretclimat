# this will install both ArcGIS entreprise and jupyter notebooks for ArcGIS

# from your computer, ssh into the machine
# ssh dti-a-idul@machine.ip.adress

# Update and reboot
sudo apt-get update
sudo apt-get upgrade
sudo reboot

# install chef: type password when prompted
#curl -L https://omnitruck.chef.io/install.sh | sudo bash
 curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P chefdk -c stable -v 4.13.3 # make sure the version is the latest

# install git if not already installed
# https://git-scm.com/download/linux

# optional: create a folder for your repos and cd into into
mkdir repos
cd repos

# get git repo from github
git clone https://github.com/jfaurelacroix/foretclimat

# alternatively
# git clone https://github.com/Esri/arcgis-cookbook

# inside the cookbooks folder, add necessary cookbooks from chef
cd cookbooks
# make sure that you have all the required license and authorization files
# to create a named license file for your machine, you'll need some specific
# information about your machine
# other missing cookbooks (using Berkshelf of arcgis-enterprise):
cd ~/repos/arcgis-cookbook/cookbooks/arcgis-enterprise
berks install
mv ~/.berkshelf/cookbooks/* ~/repos/arcgis-cookbook/cookbooks
cd ~/repos/arcgis-cookbook/cookbooks
mv limits-* limits
mv hostsfile-* hostsfile
mv windows-* windows
mv windows_firewall-* windows_firewall
mv ms_dotnet-* ms_dotnet
mv nfs-* nfs
mv java_properties-* java_properties
mv aws-* aws
mv seven_zip-* seven_zip
mv line-* line
mv openssl-* openssl
mv ohai-* ohai
mv tomcat-* tomcat
mv iptables-* iptables
mv s3_file-* s3_file
mv sysctl-* sysctl
mv tar-* tar
mv apt-* apt
mv esri-iis-* esri-iis
mv esri-tomcat-* esri-tomcat



# make sure that you have all the required tar files available (in /media/data/bkp_ArcGIS_files/)
## ArcGIS_Notebook_Docker_Advanced_109_177823.tar.gz
## ArcGIS_Notebook_Docker_Standard_109_177822.tar.gz
## ArcGIS_Notebook_Server_Linux_109_177908.tar.gz
## ArcGIS_Notebook_Server_Samples_Data_Linux_109_177914.tar.gz
## ArcGIS_Server_Linux_109_177864.tar.gz
## ArcGIS_Web_Adaptor_Java_Linux_109_177888.tar.gz
## apache-tomcat-8.5.63.tar.gz (will be downloaded from the internet if not present in the local ArcGIS software repository)
## openjdk-11_linux-x64_bin.tar.gz (will be downloaded from the internet if not present in the local ArcGIS software repository)

# make sure to have the authorization_files located at the right place
cd /media/data/bkp_ArcGIS_files
mkdir -p /opt/software/authorization_files/VERSION
sudo cp {ArcGIS_Enterprise_Portal_X.json,EducationSiteArcGISServerEnterprise_ArcGISServer_X.prvc} /opt/software/authorization_files/10.9
# make sure the arcgis-enterprise-primary.json auth file match these files.

# ArcGIS software repository directory is specified by arcgis.repository.archives attribute. By default it is set to local directory 
# /opt/software/archives on Linux. However, it is recommended to create an ArcGIS software repository 
# located on a separate file server that is accessible from all the machines in the deployment for the user account used to run Chef client.

# if needed, transfer files from valerias globus endpoint
scp -r idul@login.valeria.science:projects/ul-val-prj-foret-climat_at_valeria.science/incoming/ .

# Enable running sudo without password for the user running the Chef client.

# Give rights to user
sudo chown -R user /gisdata
sudo chmod 755 -R /gisdata

#
sudo apt-get install snapd
sudo snap install --classic certbot
sudo certbot certonly --standalone
# Type in the DNS (www.foretclimat.ca)

sudo cp /etc/letsencrypt/live/www.foretclimat.ca/fullchain.pem ~
sudo cp /etc/letsencrypt/live/www.foretclimat.ca/privkey.pem ~
cd ~
sudo openssl pkcs12 -inkey privkey.pem -in fullchain.pem -export -out cert.pfx
# Give rights to the user
sudo chown user cert.pfx
sudo chmod 755 cert.pfx

# locate the chef script you will need to use

# move the chef script to ~/repos
cp ~/repos/foretclimat/arcgis-enterprise-primary.json ~/repos/arcgis_cookbook

# run the chef script
sudo chef-client -z -j arcgis-enterprise-primary.json
#####################################################################
# your first run of chef will request that you accept 2
# product licenses

# If you don't plan adding standby machine in the future, don't configure the file server 
# and use local paths instead of shared directories for ArcGIS Server server directories, 
# Portal for ArcGIS content directory, and ArcGIS Data Store backup directories in arcgis-enterprise-primary.json.